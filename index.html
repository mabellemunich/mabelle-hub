<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MaBelle Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "lucide-react": "https://esm.sh/lucide-react@0.294.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>body { background-color: #020617; color: white; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, query, onSnapshot, doc, setDoc, deleteDoc, updateDoc, addDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { Shield, Grid, ShoppingCart, Calendar, Briefcase, LogOut, UserPlus, Trash2, Check, X, User, Lock, ExternalLink, Pencil, Save, Activity, Clock, LayoutList, Users, Timer, Settings, Globe, Loader } from 'lucide-react';

        const DEFAULT_APPS = [
          { id: 'manager', name: 'MABELLE MANAGER', description: 'Verwaltung & Finanzen', defaultUrl: 'https://mabelle-manager.netlify.app', icon: Briefcase, color: 'bg-slate-700' },
          { id: 'order', name: 'MABELLE ORDER', description: 'Bestellwesen & Lager', defaultUrl: 'https://mabelle-order.netlify.app', icon: ShoppingCart, color: 'bg-emerald-700' },
          { id: 'booking', name: 'MABELLE BOOKING', description: 'Termine & Kunden', defaultUrl: 'https://mabelle-booking.netlify.app', icon: Calendar, color: 'bg-rose-700' },
          { id: 'timer', name: 'MABELLE TIMER', description: 'Zeiterfassung & Stempeluhr', defaultUrl: 'https://mabelle-timer.netlify.app', icon: Timer, color: 'bg-indigo-700' }
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyBVO3jh0d1FjC0smGcn88eXS16GI1S6PDE",
            authDomain: "mabelle-hub.firebaseapp.com",
            projectId: "mabelle-hub",
            storageBucket: "mabelle-hub.firebasestorage.app",
            messagingSenderId: "242799712815",
            appId: "1:242799712815:web:9c7696ca5c73dc8c5b44da"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mabelle-hub-live';

        const PinPad = ({ onComplete, disabled }) => {
          const [pin, setPin] = useState('');
          const handleNum = (num) => {
            if (disabled) return;
            if (pin.length < 4) {
              const newPin = pin + num;
              setPin(newPin);
              if (newPin.length === 4) setTimeout(() => { onComplete(newPin); setPin(''); }, 300);
            }
          };
          return (
            <div className="flex flex-col items-center justify-center p-6 bg-slate-900 border border-slate-800 rounded-2xl shadow-2xl max-w-xs mx-auto">
              <div className="mb-6 flex gap-3 h-6">{[0, 1, 2, 3].map(i => <div key={i} className={`w-4 h-4 rounded-full border-2 transition-all ${pin.length > i ? 'bg-amber-600 border-amber-600 scale-110' : 'border-slate-700'}`} />)}</div>
              <div className="grid grid-cols-3 gap-4">
                {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => <button key={num} type="button" onClick={() => handleNum(num)} disabled={disabled} className="w-16 h-16 rounded-full bg-slate-800 text-2xl font-semibold text-slate-200 hover:bg-slate-700 active:bg-slate-600 disabled:opacity-50">{num}</button>)}
                <div className="w-16 h-16"></div>
                <button type="button" onClick={() => handleNum(0)} disabled={disabled} className="w-16 h-16 rounded-full bg-slate-800 text-2xl font-semibold text-slate-200 hover:bg-slate-700 active:bg-slate-600 disabled:opacity-50">0</button>
                <button type="button" onClick={() => setPin(pin.slice(0, -1))} disabled={disabled} className="w-16 h-16 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-800 disabled:opacity-50"><X size={28} /></button>
              </div>
            </div>
          );
        };

        function MaBelleHub() {
          const [user, setUser] = useState(null);
          const [staffList, setStaffList] = useState([]);
          const [logs, setLogs] = useState([]);
          const [customUrls, setCustomUrls] = useState({});
          const [activeStaff, setActiveStaff] = useState(null);
          const [view, setView] = useState('loading');
          const [error, setError] = useState('');
          const [formData, setFormData] = useState({ name: '', pin: '', isAdmin: false });
          const [editingId, setEditingId] = useState(null);
          const [adminTab, setAdminTab] = useState('staff');
          const [urlForm, setUrlForm] = useState({});

          // Authentifizierung
          useEffect(() => { 
            signInAnonymously(auth).catch(e => console.error(e)); 
            return onAuthStateChanged(auth, setUser); 
          }, []);

          // Daten & Session Restore
          useEffect(() => {
            if (!user) return;
            
            const unsubStaff = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'staff')), (snap) => {
              const staff = [];
              snap.forEach(d => staff.push({ id: d.id, ...d.data() }));
              setStaffList(staff);

              // SESSION RESTORE LOGIK: Prüfen ob wir eingeloggt sein sollten
              const savedUserId = sessionStorage.getItem('mabelle_hub_user_id');
              
              if (savedUserId && staff.length > 0) {
                  // Versuch den User aus der Session wiederherzustellen
                  const restoredUser = staff.find(s => s.id === savedUserId);
                  if (restoredUser) {
                      setActiveStaff(restoredUser);
                      setView('dashboard');
                  } else {
                      // User existiert nicht mehr (wurde gelöscht während man eingeloggt war)
                      sessionStorage.removeItem('mabelle_hub_user_id');
                      if (view === 'loading') setView('login');
                  }
              } else if (activeStaff) {
                  // Wir sind eingeloggt, Daten aktualisieren
                  const updatedMe = staff.find(s => s.id === activeStaff.id);
                  if (updatedMe) setActiveStaff(updatedMe);
              } else {
                  // Nicht eingeloggt
                  if (view === 'loading') setView('login');
              }
            });

            const unsubConfig = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'app_urls'), (snap) => {
              if (snap.exists()) { setCustomUrls(snap.data()); setUrlForm(snap.data()); }
            });
            return () => { unsubStaff(); unsubConfig(); };
          }, [user]); 

          useEffect(() => {
            if (!user || !activeStaff?.isAdmin) return;
            return onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'access_logs')), (snap) => {
              const l = []; snap.forEach(d => l.push({ id: d.id, ...d.data() }));
              setLogs(l.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)));
            });
          }, [user, activeStaff?.isAdmin]);

          const logActivity = async (type, details, staffMember) => {
            try {
              const actor = staffMember || activeStaff;
              if (actor) await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'access_logs'), {
                type, details, userId: actor.id, userName: actor.name, timestamp: new Date().toISOString()
              });
            } catch (e) {}
          };

          const handleGlobalPinLogin = (pin) => {
            const found = staffList.find(s => s.pin === pin);
            if (found) { 
                setActiveStaff(found); 
                setView('dashboard'); 
                setError(''); 
                // Session speichern!
                sessionStorage.setItem('mabelle_hub_user_id', found.id);
                logActivity('LOGIN', 'Login', found); 
            }
            else { setError('PIN falsch'); setTimeout(() => setError(''), 2000); }
          };

          const handleLogout = () => {
            setActiveStaff(null);
            setView('login');
            setFormData({ name: '', pin: '', isAdmin: false }); 
            setEditingId(null);
            // Session löschen
            sessionStorage.removeItem('mabelle_hub_user_id');
          };

          const handleAppLaunch = (appConf) => {
            const targetUrl = customUrls[appConf.id] || appConf.defaultUrl;
            logActivity('APP_ACCESS', `App: ${appConf.name}`);
            window.open(targetUrl, '_blank');
          };

          const handleSaveStaff = async (e) => {
            if(e) e.preventDefault(); // Stop Browser Reload
            if (!formData.name || formData.pin.length < 4) return;
            const exists = staffList.some(s => s.pin === formData.pin && s.id !== editingId);
            if (exists) { alert("PIN belegt!"); return; }
            
            const data = { name: formData.name, pin: formData.pin, isAdmin: formData.isAdmin };
            try {
              if (editingId) { 
                  await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', editingId), data); 
                  logActivity('ADMIN', `Edit: ${formData.name}`); 
              } else { 
                data.permissions = formData.isAdmin ? ['manager', 'order', 'booking', 'timer'] : [];
                data.createdAt = new Date().toISOString();
                await setDoc(doc(collection(db, 'artifacts', appId, 'public', 'data', 'staff')), data); 
                logActivity('ADMIN', `Neu: ${formData.name}`);
              }
              setFormData({ name: '', pin: '', isAdmin: false }); 
              setEditingId(null);
            } catch (e) { setError('Fehler'); }
          };

          const handleDeleteStaff = async (id, name, e) => {
            if(e) { e.stopPropagation(); e.preventDefault(); } // Stop Browser Reload
            if (id === activeStaff.id) return;
            if(!confirm(`Möchtest du ${name} wirklich löschen?`)) return;
            
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', id));
            logActivity('ADMIN', `Gelöscht: ${name}`);
          };

          const togglePermission = async (id, appIdTarget, perms = [], e) => {
            if(e) { e.stopPropagation(); e.preventDefault(); } // Stop Browser Reload
            const newPerms = perms.includes(appIdTarget) ? perms.filter(p => p !== appIdTarget) : [...perms, appIdTarget];
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', id), { permissions: newPerms });
          };

          const handleSaveUrls = async (e) => {
             if(e) e.preventDefault();
             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'app_urls'), urlForm);
             alert('Gespeichert');
          };

          if (view === 'loading') return <div className="min-h-screen flex items-center justify-center bg-slate-950 text-amber-600 animate-pulse">LÄDT...</div>;
          
          if (staffList.length === 0) return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-slate-950 p-4 text-center">
              <Shield className="w-16 h-16 text-amber-600 mx-auto mb-4" />
              <button type="button" onClick={async () => {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'staff', 'admin-001'), { name: 'Admin', pin: '0000', isAdmin: true, permissions: ['manager', 'order', 'booking', 'timer'] });
                window.location.reload();
              }} className="bg-amber-600 text-white py-3 px-8 rounded-xl font-bold">START (ADMIN 0000)</button>
            </div>
          );

          if (view === 'login') return (
            <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4">
              <div className="mb-10 text-center"><h1 className="text-5xl text-white tracking-widest mb-3"><span className="font-bold">MABELLE</span> <span className="font-normal text-amber-600">HUB</span></h1><p className="text-slate-500 text-xs">LOGIN</p></div>
              <PinPad onComplete={handleGlobalPinLogin} disabled={false} />
              {error && <div className="mt-8 text-rose-400 bg-rose-950/30 border border-rose-900 px-6 py-3 rounded-lg flex items-center gap-2"><Shield size={16}/> {error}</div>}
            </div>
          );

          return (
            <div className="min-h-screen bg-slate-950 text-slate-200">
              <header className="bg-slate-900 border-b border-slate-800 sticky top-0 z-10 shadow-lg px-6 h-20 flex items-center justify-between">
                <div className="flex items-center gap-3"><div className="w-10 h-10 bg-gradient-to-br from-amber-600 to-amber-700 rounded-lg flex items-center justify-center text-slate-950 font-bold">M</div><span className="text-xl tracking-widest text-white"><span className="font-bold">MABELLE</span> <span className="font-normal text-amber-600">HUB</span></span></div>
                <div className="flex items-center gap-6">
                  <div className="text-right hidden sm:block"><div className="text-sm font-medium text-white">{activeStaff.name}</div><div className="text-[10px] uppercase tracking-wider text-amber-600">{activeStaff.isAdmin ? 'Admin' : 'Mitarbeiter'}</div></div>
                  <button type="button" onClick={handleLogout} className="p-3 hover:bg-slate-800 rounded-full text-slate-500 hover:text-amber-500 transition-colors"><LogOut size={20} /></button>
                </div>
              </header>
              <main className="max-w-7xl mx-auto p-6 py-10">
                <h2 className="text-xl font-medium text-white mb-8 flex items-center gap-3"><span className="p-2 bg-slate-800 rounded-lg text-amber-500"><Grid size={20} /></span> <span className="tracking-wide">APPS</span></h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
                  {DEFAULT_APPS.map(app => {
                    const hasAccess = activeStaff.isAdmin || (activeStaff.permissions || []).includes(app.id);
                    if (!hasAccess) return null;
                    const Icon = app.icon;
                    return (
                      <button key={app.id} type="button" onClick={() => handleAppLaunch(app)} className="text-left w-full block bg-slate-900 rounded-2xl shadow-lg border border-slate-800 hover:border-amber-600/50 hover:-translate-y-1 transition-all overflow-hidden group relative">
                        <div className={`h-32 ${app.color} flex items-center justify-center text-white/90 relative overflow-hidden`}>
                          <div className="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors"></div>
                          <Icon size={48} className="opacity-90 group-hover:scale-110 group-hover:rotate-3 transition-transform duration-500 drop-shadow-md" />
                        </div>
                        <div className="p-6">
                          <h3 className="text-base font-bold text-white mb-1 flex items-center gap-2 group-hover:text-amber-500">
                            {app.name} <ExternalLink size={14} className="text-slate-600 group-hover:text-amber-500/50" />
                          </h3>
                          <p className="text-slate-400 text-xs">{app.description}</p>
                        </div>
                      </button>
                    );
                  })}
                </div>
                {activeStaff.isAdmin && (
                  <div className="border-t border-slate-800 pt-10">
                    <div className="flex gap-4 mb-6">
                       {['staff', 'apps', 'logs'].map(tab => (
                         <button key={tab} type="button" onClick={() => setAdminTab(tab)} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${adminTab === tab ? 'bg-amber-600 text-slate-950' : 'bg-slate-900 text-slate-400 hover:text-white'}`}>
                           {tab === 'staff' && <Users size={18}/>} {tab === 'apps' && <Settings size={18}/>} {tab === 'logs' && <LayoutList size={18}/>} <span className="capitalize">{tab === 'staff' ? 'Mitarbeiter' : tab}</span>
                         </button>
                       ))}
                    </div>
                    <div className="bg-slate-900 rounded-2xl shadow-xl border border-slate-800 overflow-hidden min-h-[400px]">
                      {adminTab === 'staff' && (
                        <>
                          <form onSubmit={handleSaveStaff} className={`p-8 border-b border-slate-800 flex flex-wrap gap-6 items-end ${editingId ? 'bg-amber-900/10' : ''}`}>
                            <div className="flex-1 min-w-[200px]"><label className="block text-xs font-bold text-amber-600 mb-2">Name</label><input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-3 rounded-xl bg-slate-950 border border-slate-800 text-white" placeholder="Name" /></div>
                            <div className="w-32"><label className="block text-xs font-bold text-amber-600 mb-2">PIN</label><input type="text" maxLength={4} value={formData.pin} onChange={e => setFormData({...formData, pin: e.target.value.replace(/\D/g,'')})} className="w-full px-4 py-3 rounded-xl bg-slate-950 border border-slate-800 text-white text-center" placeholder="0000" /></div>
                            <div className="flex items-center gap-2 h-12"><input type="checkbox" checked={formData.isAdmin} onChange={e => setFormData({...formData, isAdmin: e.target.checked})} className="h-5 w-5 accent-amber-600" /> <span className="text-sm text-slate-300">Admin</span></div>
                            <div className="flex gap-2">
                              {editingId && <button type="button" onClick={() => { setFormData({ name: '', pin: '', isAdmin: false }); setEditingId(null); }} className="bg-slate-800 text-slate-400 px-4 py-3 rounded-xl font-bold">X</button>}
                              <button type="submit" disabled={!formData.name || formData.pin.length < 4} className="bg-amber-600 text-slate-950 px-8 py-3 rounded-xl font-bold disabled:opacity-30">{editingId ? 'SPEICHERN' : 'ANLEGEN'}</button>
                            </div>
                          </form>
                          <div className="overflow-x-auto">
                            <table className="w-full text-left border-collapse">
                              <thead className="bg-slate-950 text-[10px] uppercase text-slate-500 border-b border-slate-800"><tr><th className="px-6 py-4">Name</th><th className="px-4 py-4 text-center">Manager</th><th className="px-4 py-4 text-center">Order</th><th className="px-4 py-4 text-center">Booking</th><th className="px-4 py-4 text-center">Timer</th><th className="px-6 py-4 text-right">Edit</th></tr></thead>
                              <tbody className="divide-y divide-slate-800">
                                {staffList.map(s => (
                                  <tr key={s.id} className="hover:bg-slate-800/30">
                                    <td className="px-6 py-4"><div className="font-bold text-white">{s.name}</div><div className="text-xs text-slate-500">PIN: {s.pin} {s.isAdmin && <span className="text-amber-600 ml-1">ADMIN</span>}</div></td>
                                    {DEFAULT_APPS.map(a => <td key={a.id} className="px-4 py-4 text-center"><button type="button" onClick={(e) => togglePermission(s.id, a.id, s.permissions, e)} disabled={s.isAdmin} className={`w-8 h-8 rounded flex items-center justify-center mx-auto ${s.isAdmin || (s.permissions||[]).includes(a.id) ? 'bg-amber-900/30 text-amber-500 border border-amber-700/50' : 'bg-slate-800 text-slate-600'}`}><Check size={16}/></button></td>)}
                                    <td className="px-6 py-4 text-right flex justify-end gap-2">
                                      <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); setFormData({ name: s.name, pin: s.pin, isAdmin: s.isAdmin || false }); setEditingId(s.id); window.scrollTo({top:0, behavior:'smooth'}); }} className="p-2 text-amber-500 hover:bg-slate-800 rounded"><Pencil size={18}/></button>
                                      <button type="button" onClick={(e) => handleDeleteStaff(s.id, s.name, e)} disabled={s.id === activeStaff.id} className="p-2 text-rose-500 hover:bg-rose-950/30 rounded disabled:opacity-20"><Trash2 size={18}/></button>
                                    </td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </>
                      )}
                      {adminTab === 'apps' && (
                        <div className="p-8 space-y-4 max-w-2xl">
                           {DEFAULT_APPS.map(a => (
                             <div key={a.id} className="flex gap-4 items-center bg-slate-950 p-4 rounded border border-slate-800">
                               <div className={`p-2 rounded ${a.color}`}><a.icon size={20}/></div>
                               <div className="flex-1"><label className="text-xs text-slate-500 block mb-1">{a.name} URL</label><input type="text" value={urlForm[a.id] || a.defaultUrl} onChange={e => setUrlForm({...urlForm, [a.id]: e.target.value})} className="w-full bg-slate-900 border border-slate-700 text-white px-3 py-2 rounded text-sm"/></div>
                             </div>
                           ))}
                           <button type="button" onClick={handleSaveUrls} className="bg-amber-600 text-slate-950 px-6 py-2 rounded font-bold">URLS SPEICHERN</button>
                        </div>
                      )}
                      {adminTab === 'logs' && (
                        <div className="overflow-x-auto max-h-[500px] overflow-y-auto">
                          <table className="w-full text-left text-sm">
                            <thead className="bg-slate-950 text-slate-500 sticky top-0"><tr><th className="px-6 py-3">Zeit</th><th className="px-6 py-3">Wer</th><th className="px-6 py-3">Was</th></tr></thead>
                            <tbody className="divide-y divide-slate-800">
                              {logs.map(l => (
                                <tr key={l.id} className="hover:bg-slate-800/30">
                                  <td className="px-6 py-3 text-slate-400 font-mono">{new Date(l.timestamp).toLocaleString('de-DE')}</td>
                                  <td className="px-6 py-3 text-white">{l.userName}</td>
                                  <td className="px-6 py-3 text-slate-300">{l.details}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </main>
            </div>
          );
        }
        createRoot(document.getElementById('root')).render(<MaBelleHub />);
    </script>
</body>
</html>
